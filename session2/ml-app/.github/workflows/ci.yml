# This is the GitHub Actions workflow file for Task 5


name: Python CI Pipeline

# 1. Run on push and pull_request
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # 2. Checkout the code
    - name: Check out repo
      uses: actions/checkout@v4

    # 2. Set up Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 2. Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel
        # Install from our requirements file
        pip install -r requirements.txt
        # Install the tools for CI (flake8, pytest)
        # and Flask, which we added manually
        pip install flake8 pytest flask

    # 2. Run the linter
    - name: Lint with flake8
      run: |
        # This will fail the build if there are any linting errors
        # (which is good!)
        flake8 src tests --count --statistics

    # 2. Run tests and produce test results/artifacts
    - name: Run tests with pytest
      run: |
        # Create a directory for the test results
        mkdir -p test-results
        # Run pytest and output a JUnit XML report
        pytest --junitxml=test-results/junit.xml

    # 3. Use action to upload test results artifact
    - name: Upload test results
      # 'if: always()' ensures this runs even if tests fail
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-results
        path: test-results/junit.xml

    # 2. Build a Docker image
    - name: Build Docker image
      run: |
        # This step assumes a 'Dockerfile' exists in the root
        docker build . --file Dockerfile --tag my-image:latest

    # 2. Upload the image artifact
    - name: Save Docker image as a .tar file
      run: |
        docker save --output app-image.tar my-image:latest
        
    # 3. Use action to upload image artifact
    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: app-image.tar


        