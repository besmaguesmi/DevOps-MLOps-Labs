# This is the GitHub Actions workflow file for Task 5
# It should be placed at: .github/workflows/ci.yml

name: Python CI Pipeline

# 1. Run on push and pull_request
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # 2. Checkout the code
    - name: Check out repo
      uses: actions/checkout@v4

    # 2. Set up Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 2. Install dependencies
    - name: Install dependencies
      # This step now runs inside the correct folder
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel
        pip install -r requirements.txt
        pip install flake8 pytest flask
      working-directory: session2/ml-app

    # 2. Run the linter
    - name: Lint with flake8
      run: |
        flake8 src tests --count --statistics
      working-directory: session2/ml-app

    # 2. Run tests and produce test results/artifacts
    - name: Run tests with pytest
      run: |
        mkdir -p ../test-results
        pytest --junitxml=../test-results/junit.xml
      working-directory: session2/ml-app

    # 3. Use action to upload test results artifact
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-results
        path: test-results/junit.xml # Path is now at the root

    # 2. Build a Docker image
    - name: Build Docker image
      run: |
        docker build . --file Dockerfile --tag my-image:latest
      working-directory: session2/ml-app

    # 2. Upload the image artifact
    - name: Save Docker image as a .tar file
      run: |
        docker save --output ../app-image.tar my-image:latest
      working-directory: session2/ml-app
        
    # 3. Use action to upload image artifact
    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: app-image.tar